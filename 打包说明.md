# 打包说明

本项目支持多种打包方式，可以根据需求选择合适的方式。

## 快速开始

使用提供的打包脚本：

```bash
./build.sh
```

然后根据提示选择打包方式。

## 打包方式

### 方式一：Docker 镜像打包（推荐用于部署）

**优点**：
- 环境隔离，依赖完整
- 易于部署和分发
- 支持多平台

**步骤**：

```bash
# 构建镜像
docker build -t tiktok-downloader-api:latest .

# 查看镜像
docker images | grep tiktok-downloader

# 导出镜像（可选）
docker save tiktok-downloader-api:latest | gzip > tiktok-downloader-api.tar.gz

# 在其他机器上导入镜像
docker load < tiktok-downloader-api.tar.gz
```

**使用**：

```bash
# 运行容器
docker run -d \
  --name tiktok-downloader-api \
  -p 5555:5555 \
  -v $(pwd)/Volume:/app/Volume \
  -e DOUYIN_COOKIE="your-cookie" \
  tiktok-downloader-api:latest
```

### 方式二：PyInstaller 可执行文件打包

**优点**：
- 生成单个可执行文件
- 无需安装 Python 环境
- 适合 Linux 系统分发

**步骤**：

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 安装 PyInstaller
pip install pyinstaller

# 3. 打包
pyinstaller \
  --name="DouK-Downloader" \
  --onefile \
  --add-data "static:static" \
  --add-data "locale:locale" \
  --collect-all emoji \
  --hidden-import=uvicorn \
  --hidden-import=fastapi \
  --hidden-import=httpx \
  main.py

# 4. 可执行文件在 dist/DouK-Downloader
```

**使用**：

```bash
# 运行可执行文件
./dist/DouK-Downloader api
```

**注意事项**：
- 可执行文件较大（通常 50-100MB）
- 首次运行可能较慢
- 需要确保目标系统架构兼容

### 方式三：源代码打包

**优点**：
- 文件小
- 保留所有源代码
- 适合开发和定制

**步骤**：

```bash
# 方式 1: 使用脚本
./build.sh
# 选择选项 3 或 4

# 方式 2: 手动打包
# tar.gz 格式
tar -czf DouK-Downloader-$(date +%Y%m%d).tar.gz \
  --exclude='venv' \
  --exclude='__pycache__' \
  --exclude='.git' \
  --exclude='*.pyc' \
  --exclude='*.log' \
  --exclude='Volume/Cache' \
  .

# zip 格式
zip -r DouK-Downloader-$(date +%Y%m%d).zip . \
  -x 'venv/*' '__pycache__/*' '.git/*' '*.pyc' '*.log' 'Volume/Cache/*'
```

**使用**：

```bash
# 解压
tar -xzf DouK-Downloader-*.tar.gz
# 或
unzip DouK-Downloader-*.zip

# 安装依赖并运行
cd DouK-Downloader-*
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python3 main.py api
```

## 打包脚本使用

项目提供了 `build.sh` 脚本，支持交互式打包：

```bash
# 运行脚本
./build.sh

# 根据提示选择：
# 1. Docker 镜像打包
# 2. PyInstaller 可执行文件打包
# 3. 源代码打包（tar.gz）
# 4. 源代码打包（zip）
```

## 打包前准备

### 1. 清理临时文件

```bash
# 清理 Python 缓存
find . -type d -name __pycache__ -exec rm -r {} +
find . -type f -name "*.pyc" -delete

# 清理日志
rm -f *.log api.log

# 清理构建目录
rm -rf build dist *.spec
```

### 2. 检查依赖

```bash
# 确保 requirements.txt 是最新的
pip freeze > requirements-check.txt

# 检查是否有缺失的依赖
pip install -r requirements.txt
```

### 3. 测试程序

```bash
# 确保程序可以正常运行
source venv/bin/activate
python3 main.py --help
```

## 打包文件说明

### Docker 镜像
- **文件**：Docker 镜像（存储在 Docker 中）
- **大小**：约 200-300 MB
- **用途**：容器化部署

### PyInstaller 可执行文件
- **文件**：`dist/DouK-Downloader`
- **大小**：约 50-100 MB
- **用途**：Linux 系统直接运行

### 源代码包
- **文件**：`DouK-Downloader-YYYYMMDD.tar.gz` 或 `.zip`
- **大小**：约 5-10 MB
- **用途**：源代码分发和部署

## 分发建议

### 生产环境
- **推荐**：Docker 镜像
- **原因**：环境一致，易于管理

### 个人使用
- **推荐**：源代码包
- **原因**：灵活，可定制

### 无 Python 环境
- **推荐**：PyInstaller 可执行文件
- **原因**：无需安装依赖

## 常见问题

### Q1: PyInstaller 打包失败？

**A**: 检查以下几点：
1. 确保所有依赖都已安装
2. 检查是否有缺失的隐藏导入（使用 `--hidden-import`）
3. 查看 PyInstaller 的错误日志

### Q2: Docker 镜像太大？

**A**: 可以尝试：
1. 使用多阶段构建（已实现）
2. 清理不必要的文件
3. 使用 Alpine 基础镜像（可能需要调整）

### Q3: 可执行文件无法运行？

**A**: 检查：
1. 文件权限：`chmod +x DouK-Downloader`
2. 系统架构是否匹配
3. 依赖库是否完整

## 版本管理

建议在打包时包含版本信息：

```bash
# 在文件名中包含版本
VERSION="5.8"
docker build -t tiktok-downloader-api:v${VERSION} .
```

## 自动化打包

可以使用 CI/CD 工具（如 GitHub Actions）实现自动化打包，项目已包含相关配置。

